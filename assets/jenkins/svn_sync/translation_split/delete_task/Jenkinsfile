@Library("jenkins_library") _

def build = new org.devops.build()

pipeline {
    agent any
    options {
        disableConcurrentBuilds()
    }

    stages {
        stage('init') {
            steps{
                script {
                    build.checkoutAutomator()
                }
            }
        }
        
        stage('build') {
            steps {
                script {
                    bat '%WORKSPACE%/automator/automator LSB0eXBlOiBlbnZfb3B0aW9uYWwNCiAgcmF3OiB0cnVlDQogIGRhdGE6DQogICAgQVBQSURfVVNFUk5BTUVfUEFTU1dPUkQ6DQogICAgT0FVVEhfTE9HSU5fVVJMOiBodHRwczovL3B1Ymxpc2hlci5nMTIzLmpwL29hdXRoMi9sb2dpbg0KICAgIFBST0pFQ1RTX1VSTDogaHR0cHM6Ly9pMTluLWFwaS5nMTIzLmpwL2FwaS92MS9nYW1lcy88PEFQUElEPj4vcHJvamVjdHMNCiAgICBUQVNLU19VUkw6IGh0dHBzOi8vaTE5bi1hcGkuZzEyMy5qcC9hcGkvdjEvZ2FtZXMvPDxBUFBJRD4+L3RleHQtdGFza3M/cGFnZT0xJnN0YXR1cz1hbGwNCiAgICBSRVFVRVNUX1RBU0tfVVJMOiBodHRwczovL2kxOW4tYXBpLmcxMjMuanAvYXBpL3YxL3RleHQtdGFza3MvPDxUQVNLX0lEPj4NCiAgICBERUxFVEVfVEFTS19VUkw6IGh0dHBzOi8vaTE5bi1hcGkuZzEyMy5qcC9hcGkvdjEvdGV4dC10YXNrcy88PFRBU0tfSUQ+Pg0KICAgIFNPVVJDRV9VUkw6IGh0dHBzOi8vaTE5bi1hcGkuZzEyMy5qcC9hcGkvdjEvZ2FtZXMvPDxBUFBJRD4+L3RleHQtc291cmNlcz90ZXh0VGFza0lkPTw8VEFTS19JRD4+DQogICAgUkVNT1ZFX1RBU0tfSURTOg0KICAgIFJFTU9WRV9BTEw6IGZhbHNlDQoNCi0gdHlwZTogZXZhbA0KICBkYXRhOg0KICAgIGNvZGU6ID4NCiAgICAgICgoKSA9PiB7DQogICAgICAgIHZhciBrZXkgPSAiQVBQSURfVVNFUk5BTUVfUEFTU1dPUkQiOw0KICAgICAgICB2YXIgdmFsdWUgPSB0aGlzW2tleV07DQogICAgICAgIHZhciBrZXlzID0ga2V5LnNwbGl0KCJfIik7DQogICAgICAgIHZhciB2YWx1ZXMgPSB2YWx1ZS5zcGxpdCgiICIpOw0KICAgICAgICBrZXlzLmZvckVhY2goKGtleSwgaWR4KSA9PiB7DQogICAgICAgICAgdGhpc1trZXldID0gdmFsdWVzW2lkeF07DQogICAgICAgIH0pDQogICAgICB9KSgpDQoNCi0gdHlwZTogd2hpY2gNCiAgZGF0YToNCiAgICB0YXJnZXQ6IHBoYW50b21qcw0KICAgIHN0b3JlX2tleTogUEhBTlRPTUpTDQoNCi0gdHlwZTogYXNzZXJ0DQogIGRhdGE6DQogICAga2V5Og0KICAgICAgLSBBUFBJRA0KICAgICAgLSBVU0VSTkFNRQ0KICAgICAgLSBQQVNTV09SRA0KICAgICAgLSBPQVVUSF9MT0dJTl9VUkwNCiAgICAgIC0gUFJPSkVDVFNfVVJMDQogICAgICAtIFRBU0tTX1VSTA0KICAgICAgLSBSRVFVRVNUX1RBU0tfVVJMDQogICAgICAtIERFTEVURV9UQVNLX1VSTA0KICAgICAgLSBTT1VSQ0VfVVJMDQogICAgICAtIFBIQU5UT01KUw0KDQotIHR5cGU6IHN0b3JhZ2UNCiAgZGF0YToNCiAgICBnZXRfb2F1dGhfbG9naW5fY29kZV9maWxlOiA8PEFVVE9NQVRPUl9TQ1JBVENIPj4vdHJhbnNsYXRpb25fc3BsaXQvZ2V0X29hdXRoX2xvZ2luX2NvZGUuanMNCi0gdHlwZTogd3JpdGVfcGxhaW4NCiAgZGF0YToNCiAgICBjb250ZW50OiA+IA0KICAgICAgdmFyIExPR0lOX0NBTExCQUNLX0NPREUgPSAiIjsNCiAgICAgIHZhciBsZWZ0VXJsQ2hhbmdlZFRpbWVzID0gMjsNCiAgICAgIHZhciBwYWdlID0gcmVxdWlyZSgid2VicGFnZSIpLmNyZWF0ZSgpOw0KDQogICAgICBwYWdlLm9uQWxlcnQ9ZnVuY3Rpb24obXNnKXt9Ow0KICAgICAgcGFnZS5vblByb21wdD1mdW5jdGlvbihtc2csZGVmYXVsdFZhbCl7fTsNCiAgICAgIHBhZ2Uub25Db25maXJtPWZ1bmN0aW9uKG1zZyl7fTsNCiAgICAgIHBhZ2Uub25Db25zb2xlTWVzc2FnZT1mdW5jdGlvbihtc2csbGluZU51bSxzb3VyY2VJZCl7fTsNCiAgICAgIHBhZ2Uub25Jbml0aWFsaXplZCA9IGZ1bmN0aW9uKCkge307DQogICAgICBwYWdlLm9uVXJsQ2hhbmdlZCA9IGZ1bmN0aW9uKHVybCkge307DQogICAgICBwYWdlLm9uTG9hZFN0YXJ0ZWQgPSBmdW5jdGlvbigpIHt9Ow0KICAgICAgcGFnZS5vbkxvYWRGaW5pc2hlZCA9IGZ1bmN0aW9uICgpIHt9Ow0KICAgICAgcGFnZS5vbk5hdmlnYXRpb25SZXF1ZXN0ZWQ9ZnVuY3Rpb24odXJsLHR5cGUsd2lsbE5hdmlnYXRlLG1haW4pe307DQogICAgICBwYWdlLm9uUmVzb3VyY2VSZXF1ZXN0ZWQgPSBmdW5jdGlvbihyZXF1ZXN0KSB7fTsNCiAgICAgIHBhZ2Uub25SZXNvdXJjZVJlY2VpdmVkID0gZnVuY3Rpb24ocmVzcG9uc2UpIHt9Ow0KICAgICAgcGFnZS5vblJlc291cmNlRXJyb3IgPSBmdW5jdGlvbihlcnJvcikge307DQogICAgICBwYWdlLm9uUmVzb3VyY2VUaW1lb3V0ID0gZnVuY3Rpb24ocmVxdWVzdCkge307DQogICAgICBwYWdlLm9uRXJyb3IgPSBmdW5jdGlvbihtc2csIHRyYWNlKSB7fTsNCiAgICAgIHBoYW50b20ub25FcnJvciA9IGZ1bmN0aW9uKG1zZywgdHJhY2UpIHt9Ow0KDQogICAgICBwYWdlLm9uVXJsQ2hhbmdlZCA9IGZ1bmN0aW9uICh1cmwpIHsNCiAgICAgICAgbGVmdFVybENoYW5nZWRUaW1lcy0tOw0KICAgICAgICB2YXIgbWF0Y2hlZCA9IHVybC5tYXRjaCgvW1w/Jl1jb2RlPShbXiZdKilbJiRdLyk7DQogICAgICAgIGlmIChtYXRjaGVkKSB7DQogICAgICAgICAgTE9HSU5fQ0FMTEJBQ0tfQ09ERSA9IG1hdGNoZWRbMV07DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIHBhZ2Uub25Mb2FkRmluaXNoZWQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmIChsZWZ0VXJsQ2hhbmdlZFRpbWVzIDw9IDApIHsNCiAgICAgICAgICBjb25zb2xlLmxvZyhMT0dJTl9DQUxMQkFDS19DT0RFKTsNCiAgICAgICAgICBwaGFudG9tLmV4aXQoKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgcGFnZS5vcGVuKCI8PE9BVVRIX0xPR0lOX1VSTHxmb3JtYXQ+PiIsIGZ1bmN0aW9uIChzdGF0dXMpIHsNCiAgICAgICAgcGFnZS5ldmFsdWF0ZShmdW5jdGlvbiAoKSB7DQogICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3VzZXJuYW1lIikudmFsdWUgPSAiPDxVU0VSTkFNRT4+IjsNCiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjcGFzc3dvcmQiKS52YWx1ZSA9ICI8PFBBU1NXT1JEPj4iOw0KICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImZvcm0iKS5zdWJtaXQoKTsNCiAgICAgICAgfSk7DQogICAgICB9KTsNCiAgICBkc3Q6IDw8Z2V0X29hdXRoX2xvZ2luX2NvZGVfZmlsZT4+DQotIHR5cGU6IGxvb3ANCiAgcmV0cnk6IDMNCiAgZGF0YToNCiAgICBjb250ZW50OiBbMV0NCiAgICBjb21tYW5kczoNCiAgICAgICMg6I635Y+WIGNvZGUNCiAgICAgIC0gdHlwZTogc2hlbGwNCiAgICAgICAgZGF0YToNCiAgICAgICAgICBjbWQ6IA0KICAgICAgICAgICAgLSA8PFBIQU5UT01KUz4+DQogICAgICAgICAgICAtIC0tb3V0cHV0LWVuY29kaW5nPWdiaw0KICAgICAgICAgICAgLSA8PGdldF9vYXV0aF9sb2dpbl9jb2RlX2ZpbGU+Pg0KICAgICAgICAgIGNhcHR1cmVfc3Rkb3V0OiB0cnVlDQogICAgICAgICAgc3RvcmVfdHJpbTogdHJ1ZQ0KICAgICAgICAgIHN0b3JlX2tleTogb2F1dGhfbG9naW5fY29kZQ0KICAgICAgICAgIHN0b3JlX3ByaW50OiB0cnVlDQoNCiAgICAgICMjIOiOt+WPliBhY2Nlc3NfdG9rZW4NCiAgICAgIC0gdHlwZTogcmVxdWVzdA0KICAgICAgICBkYXRhOg0KICAgICAgICAgIHNyYzogPDxPQVVUSF9MT0dJTl9VUkx8Zm9ybWF0Pj4NCiAgICAgICAgICBvcHRpb25zOiANCiAgICAgICAgICAgIG1ldGhvZDogUE9TVA0KICAgICAgICAgICAganNvbjoNCiAgICAgICAgICAgICAgY29kZTogPDxvYXV0aF9sb2dpbl9jb2RlPj4NCiAgICAgICAgICBzdG9yZV9rZXk6IHRva2VuX2RhdGENCiAgICAgICAgICANCg0KLSB0eXBlOiBlbnZfb3B0aW9uYWwNCiAgZGF0YToNCiAgICBBdXRob3JpemF0aW9uOiA8PHRva2VuX2RhdGEudG9rZW5fdHlwZT4+IDw8dG9rZW5fZGF0YS5hY2Nlc3NfdG9rZW4+Pg0KDQotIHR5cGU6IHJlcXVlc3QNCiAgZGF0YToNCiAgICBxdWlldDogdHJ1ZQ0KICAgIHNyYzogPDxUQVNLU19VUkx8Zm9ybWF0Pj4NCiAgICBvcHRpb25zOiANCiAgICAgIGhlYWRlcnM6DQogICAgICAgIEF1dGhvcml6YXRpb246IDw8QXV0aG9yaXphdGlvbj4+DQogICAgcGFyc2VfdHlwZToganNvbg0KICAgIHN0b3JlX2tleTogdGFza3MNCg0KLSB0eXBlOiBsb29wDQogIHNob3dfcHJvZ3Jlc3M6IHRydWUNCiAgZGF0YToNCiAgICBrZXk6IHRhc2tzLmRhdGENCiAgICB2YWx1ZV9tYXBwaW5nOiB0YXNrDQogICAgdGlwX2tleTogdGFzay5pZA0KICAgIGNvbW1hbmRzOg0KICAgICAgLSB0eXBlOiBzdG9yYWdlDQogICAgICAgIGRhdGE6DQogICAgICAgICAgVEFTS19JRDogPDx0YXNrLmlkPj4NCiAgICAgIC0gdHlwZTogY29udGludWUNCiAgICAgICAgd2hlbjogdGhpcy5SRU1PVkVfVEFTS19JRFMuaW5kZXhPZih0aGlzLlRBU0tfSUQpID09IC0xICYmICF0aGlzLlJFTU9WRV9BTEwNCiAgICAgIC0gdHlwZTogcmVxdWVzdA0KICAgICAgICB3aGVuOiB0aGlzLnRhc2suc3RhdHVzID09ICJkdXBsaWNhdGUiDQogICAgICAgIGRhdGE6DQogICAgICAgICAgc3JjOiA8PERFTEVURV9UQVNLX1VSTHxmb3JtYXQ+Pg0KICAgICAgICAgIHF1aWV0OiB0cnVlDQogICAgICAgICAgb3B0aW9uczogDQogICAgICAgICAgICBtZXRob2Q6IERFTEVURQ0KICAgICAgICAgICAgaGVhZGVyczoNCiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogPDxBdXRob3JpemF0aW9uPj4NCiAgICAgIC0gdHlwZTogY29udGludWUNCiAgICAgICAgd2hlbjogdGhpcy50YXNrLnN0YXR1cyA9PSAiZHVwbGljYXRlIg0KICAgICAgLSB0eXBlOiByZXF1ZXN0DQogICAgICAgIGRhdGE6DQogICAgICAgICAgc3JjOiA8PFNPVVJDRV9VUkx8Zm9ybWF0Pj4NCiAgICAgICAgICBxdWlldDogdHJ1ZQ0KICAgICAgICAgIG9wdGlvbnM6IA0KICAgICAgICAgICAgbWV0aG9kOiBHRVQNCiAgICAgICAgICAgIGhlYWRlcnM6DQogICAgICAgICAgICAgIEF1dGhvcml6YXRpb246IDw8QXV0aG9yaXphdGlvbj4+DQogICAgICAgICAgcGFyc2VfdHlwZToganNvbg0KICAgICAgICAgIHN0b3JlX2tleTogdGFza1NvdXJjZXMNCiAgICAgIC0gdHlwZTogbG9vcA0KICAgICAgICBzaG93X3Byb2dyZXNzOiB0cnVlDQogICAgICAgIHdoZW46IHRoaXMudGFza1NvdXJjZXMuZGF0YS5sZW5ndGggIT0gMA0KICAgICAgICBkYXRhOg0KICAgICAgICAgIGNvbnRlbnQ6IDw8dGFza1NvdXJjZXMuZGF0YXxjaHVuaz4+DQogICAgICAgICAgdmFsdWVfbWFwcGluZzogY2h1bmsNCiAgICAgICAgICBjb21tYW5kczoNCiAgICAgICAgICAgIC0gdHlwZTogZXZhbA0KICAgICAgICAgICAgICBkYXRhOg0KICAgICAgICAgICAgICAgIGNvZGU6ID4NCiAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtzb3VyY2VJZHM6IHRoaXMuY2h1bmsubWFwKHYgPT4gdi5pZCl9KQ0KICAgICAgICAgICAgICAgIHN0b3JlX2tleTogYm9keQ0KICAgICAgICAgICAgLSB0eXBlOiByZXF1ZXN0DQogICAgICAgICAgICAgIGRhdGE6DQogICAgICAgICAgICAgICAgc3JjOiA8PFNPVVJDRV9VUkx8Zm9ybWF0Pj4NCiAgICAgICAgICAgICAgICBxdWlldDogdHJ1ZQ0KICAgICAgICAgICAgICAgIG9wdGlvbnM6IA0KICAgICAgICAgICAgICAgICAgbWV0aG9kOiBERUxFVEUNCiAgICAgICAgICAgICAgICAgIGJvZHk6IDw8Ym9keT4+DQogICAgICAgICAgICAgICAgICBoZWFkZXJzOg0KICAgICAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiA8PEF1dGhvcml6YXRpb24+Pg0KICAgICAgLSB0eXBlOiByZXF1ZXN0DQogICAgICAgIGRhdGE6DQogICAgICAgICAgc3JjOiA8PFNPVVJDRV9VUkx8Zm9ybWF0Pj4NCiAgICAgICAgICBxdWlldDogdHJ1ZQ0KICAgICAgICAgIG9wdGlvbnM6IA0KICAgICAgICAgICAgbWV0aG9kOiBQVVQNCiAgICAgICAgICAgIGhlYWRlcnM6DQogICAgICAgICAgICAgIEF1dGhvcml6YXRpb246IDw8QXV0aG9yaXphdGlvbj4+DQoNCiAgICAgICAgICAgICAgDQogICAg'
                }
            }
        }
    }


    post { 
        always { 
            script {
                build.sendCommonResult2DingTalk()
            }
        }
    }
}
