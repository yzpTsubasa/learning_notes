@Library("jenkins_library") _

def build = new org.devops.build()

pipeline {
    agent any

    stages {
        stage('clean') {
            steps {
                print "clean"
                // deleteDir()
            }
        }
        stage('install hgbuild') {
            steps {
                script {
                    if (params.UPDATE_HGBUILDLIB) {
                        bat 'npm config set "@hotgame:registry" http://192.168.1.205:7000/'
                        bat 'npm install -g @hotgame/hgbuildlib'
                        bat 'hgtsc --version'        
                    }
                }
            }
        }
        stage('checkout') {
            steps {
                script {
                    build.checkoutAutomator()
                    if (!env.HG_PROTOBUF_PATH) {
                        env.HG_PROTOBUF_PATH = "src/protobuf/proto"
                    }
                    if (!env.HG_EXTRA_CREDENTIALS_ID) {
                        env.HG_EXTRA_CREDENTIALS_ID = '81e61ad7-0457-456c-b158-84db028669b9'
                    }
                    dir("project/${env.HG_PROTOBUF_PATH}") {
                        build.checkoutSVN("${params.HG_REPOSITORY_SRC}/${env.HG_PROTOBUF_PATH}", false, false)
                    }
                    if (env.HG_CFGJSON_PATH) {
                        def CFGJSON_PARENT = getParent(env.HG_CFGJSON_PATH)
                        dir("project/${CFGJSON_PARENT}") {
                            build.checkoutSVN("${params.HG_REPOSITORY_SRC}/${CFGJSON_PARENT}", false, false)    
                        }
                    }
                    dir("protobuf") {
                        checkout([$class: 'SubversionSCM', additionalCredentials: [], excludedCommitMessages: '', excludedRegions: '', excludedRevprop: '', excludedUsers: '', filterChangelog: false, ignoreDirPropChanges: false, includedRegions: '', locations: [[cancelProcessOnExternalsFail: true, credentialsId: env.HG_EXTRA_CREDENTIALS_ID, depthOption: 'infinity', ignoreExternalsOption: true, local: '.', remote: params.HG_REPOSITORY_SRC_PROTOBUF]], quietOperation: true, workspaceUpdater: [$class: 'UpdateUpdater']])
                    }
                    // 获取凭证
                    withCredentials([usernamePassword(credentialsId: build.getCredentialsId(), passwordVariable: 'HG_CREDENTIAL_PASSWORD', usernameVariable: 'HG_CREDENTIAL_USERNAME')]) {
                        env.SVN_CREDENTIAL = "--username ${HG_CREDENTIAL_USERNAME} --password ${HG_CREDENTIAL_PASSWORD}"
                    }
                    if (env.HG_REPOSITORY_SRC_MODULE_ERR_CODE) {
                        def MODULE_ERR_CODE_PARENT = getParent(env.HG_REPOSITORY_SRC_MODULE_ERR_CODE)
                        def MODULE_ERR_CODE_NAME = getName(env.HG_REPOSITORY_SRC_MODULE_ERR_CODE)
                        def CFGJSON_NAME = getName(env.HG_CFGJSON_PATH)
                        dir("module_err_code") {
                            checkout([$class: 'SubversionSCM', additionalCredentials: [], excludedCommitMessages: '', excludedRegions: '', excludedRevprop: '', excludedUsers: '', filterChangelog: false, ignoreDirPropChanges: false, includedRegions: '', locations: [[cancelProcessOnExternalsFail: true, credentialsId: env.HG_EXTRA_CREDENTIALS_ID, depthOption: 'infinity', ignoreExternalsOption: true, local: '.', remote: MODULE_ERR_CODE_PARENT]], quietOperation: true, workspaceUpdater: [$class: 'UpdateUpdater']])    
                        }
                        // 同步 module_err_code
                        env.MODULE_ERR_CODE_DST="${WORKSPACE}/project/${env.HG_CFGJSON_PATH}"
                        env.MODULE_ERR_CODE_SRC="${WORKSPACE}/module_err_code/${MODULE_ERR_CODE_NAME}"
                        env.SVN_COMMIT_MSG="[0] ${CFGJSON_NAME} 更新" + build.getChangeString(false).join(",")
                        bat '%WORKSPACE%/automator/automator LSB0eXBlOiBlbnZfb3B0aW9uYWwNCiAgZGF0YToNCiAgICBNT0RVTEVfRVJSX0NPREVfU1JDOiANCiAgICBNT0RVTEVfRVJSX0NPREVfRFNUOiANCiAgICBTVk5fQ1JFREVOVElBTDogDQogICAgU1ZOX0NPTU1JVF9NU0c6DQotIHR5cGU6IGFzc2VydA0KICBkYXRhOg0KICAgIGtleToNCiAgICAgIC0gTU9EVUxFX0VSUl9DT0RFX1NSQw0KICAgICAgLSBNT0RVTEVfRVJSX0NPREVfRFNUDQogICAgICAtIFNWTl9DUkVERU5USUFMDQogICAgICAtIFNWTl9DT01NSVRfTVNHDQoNCi0gdHlwZTogdHJ1bmNhdGVfYWxsDQogIGRhdGE6DQogICAgc3JjOiA8PE1PRFVMRV9FUlJfQ09ERV9TUkM+Pg0KICAgIHBhdHRlcm46IFxzKihNT0RFUlJfXFMrKVxzKlw9XHMqKFxkKyksXHMqLy8oLiopDQogICAgZmxhZ3M6IG0NCiAgICBzdG9yZV9rZXk6IG1vZHVsZV9lcnJfY29kZQ0KICAgIHN0cnVjdDogDQogICAgICAtIG5hbWU6IEVSUl9JRA0KICAgICAgICB0eXBlOiBzdHJpbmcNCiAgICAgIC0gbmFtZTogRVJSX0NPREUNCiAgICAgICAgdHlwZTogbnVtYmVyDQogICAgICAtIG5hbWU6IEVSUl9ERVNDDQogICAgICAgIHR5cGU6IHN0cmluZw0KLSB0eXBlOiByZWFkX2NmZw0KICBkYXRhOg0KICAgIHNyYzogPDxNT0RVTEVfRVJSX0NPREVfRFNUPj4NCiAgICBzdG9yZV9rZXk6IGV4aXN0aW5nX21vZHVsZV9lcnJfY29kZQ0KLSB0eXBlOiBldmFsDQogIGRhdGE6DQogICAgY29kZTogPg0KICAgICAgKCgpID0+IHsNCiAgICAgICAgdmFyIGV4aXN0aW5nTWFwID0ge307DQogICAgICAgIHRoaXMuZXhpc3RpbmdfbW9kdWxlX2Vycl9jb2RlWyI8PE1PRFVMRV9FUlJfQ09ERV9EU1R8YmFzZW5hbWVfbm9leHQ+PiJdLm1hcCgodmFsdWVzKSA9PiB7DQogICAgICAgICAgY29uc3QgRVJSX0NPREUgPSB2YWx1ZXNbMF07DQogICAgICAgICAgY29uc3QgbGVmdEFyZ3MgPSB2YWx1ZXMuc2xpY2UoMyk7DQogICAgICAgICAgZXhpc3RpbmdNYXBbRVJSX0NPREVdID0gbGVmdEFyZ3M7DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgIDw8TU9EVUxFX0VSUl9DT0RFX0RTVHxiYXNlbmFtZV9ub2V4dD4+OiB0aGlzLm1vZHVsZV9lcnJfY29kZS5tYXAoKHtFUlJfSUQsIEVSUl9DT0RFLCBFUlJfREVTQ30pID0+IHsNCiAgICAgICAgICAgIHJldHVybiBbRVJSX0NPREUsIEVSUl9JRCwgRVJSX0RFU0MsIGV4aXN0aW5nTWFwW0VSUl9DT0RFXT8uWzBdID8/IEVSUl9ERVNDLCBleGlzdGluZ01hcFtFUlJfQ09ERV0/LlsxXSA/PyAwXTsNCiAgICAgICAgICB9KQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXQ7DQogICAgICB9KSgpDQogICAgc3RvcmVfZHN0X3R5cGU6IGpzb25fY29tcGFjdGVkDQogICAgc3RvcmVfZHN0OiA8PE1PRFVMRV9FUlJfQ09ERV9EU1Q+Pg0KLSB0eXBlOiBzaGVsbA0KICBkYXRhOg0KICAgIGNtZDogc3ZuIGFkZCA8PE1PRFVMRV9FUlJfQ09ERV9EU1Q+PiAtLWZvcmNlIDw8U1ZOX0NSRURFTlRJQUw+Pg0KLSB0eXBlOiBzaGVsbA0KICBkYXRhOg0KICAgIGNtZDogc3ZuIGNvbW1pdCAtbSAiPDxTVk5fQ09NTUlUX01TRz4+IiA8PE1PRFVMRV9FUlJfQ09ERV9EU1Q+PiA8PFNWTl9DUkVERU5USUFMPj4= --FULL_AUTOMATIC 1'
                    }
                }
            }
        }
        stage('sync protobuf file') {
            steps {
                script {
                    fileOperations([fileCopyOperation(excludes: '', flattenFiles: true, includes: 'protobuf/*.proto', renameFiles: false, sourceCaptureExpression: '', targetLocation: "project/${env.HG_PROTOBUF_PATH}", targetNameExpression: '')])
                    dir("project/${env.HG_PROTOBUF_PATH}") {
                        bat 'svn add . --no-ignore --force'
                        env.HG_TMP = "[0] Protobuf更新" + build.getChangeString(false).join(",")
                        bat "@echo off && svn commit . -m \"%HG_TMP%\" %SVN_CREDENTIAL%"
                    }
                }
            }
        }
        // stage('sync protobuf code') {
        //     steps {
        //         dir("project") {
        //             bat 'hgpbts'
                    
        //             bat 'svn commit -m "[0] Update protobuf code and config automatically" src/protobuf/protobufMsg.d.ts resource/protobufMsg.json src/protobuf/IProtobuf.ts'
        //         }
        //     }
        // }
    }
    
    post { 
        changed { 
            script {
                build.sendCommonResult2DingTalk()
            }
        }
    }
}

def getParent(url) {
    return url.substring(0, url.lastIndexOf('/'))
}

def getName(url) {
    return url.substring(url.lastIndexOf('/') + 1)
}